#!/usr/bin/env node\nconst Imap = require('imap');\nconst { simpleParser } = require('mailparser');\nconst fs = require('fs');\nconst path = require('path');\n\nconst config = {\n    user: 'pierredugatpy@fastmail.com',\n    password: '256q6t8p5w5t4t3p',\n    host: 'imap.fastmail.com',\n    port: 993,\n    tls: true,\n    tlsOptions: { rejectUnauthorized: true }\n};\n\nasync function main() {\n  console.log('ðŸ” Deep scan Fastmail INBOX for schedules/attachments...');\n  return new Promise((resolve, reject) => {\n    const imap = new Imap(config);\n    imap.once('ready', () => {\n      imap.openBox('INBOX', true, (err, box) => {\n        if (err) return reject(err);\n        console.log(`Total messages: ${box.messages.total}`);\n\n        // Search for 'schedule' or 'cal' or attachments\n        imap.search([['OR', ['SUBJECT', 'schedule'], ['SUBJECT', 'cal'], ['SUBJECT', 'excel'], 'ATTACHMENT']], (err, results) => {\n          if (err) return reject(err);\n          console.log(`Search hits: ${results.length}`);\n          if (results.length === 0) {\n            // Fallback: list last 10 subjects\n            const n = Math.max(1, box.messages.total - 9);\n            const fetch = imap.seq.fetch(`${n}:${box.messages.total}`, {\n              bodies: 'HEADER.FIELDS (SUBJECT FROM DATE)',\n              struct: true\n            });\n            const emails = [];\n            fetch.on('message', (msg, seqno) => {\n              msg.on('body', (stream, info) => {\n                let buffer = '';\n                stream.on('data', chunk => buffer += chunk);\n                stream.once('end', () => {\n                  if (info.which.includes('HEADER')) {\n                    const headers = Imap.parseHeader(buffer);\n                    emails.push({\n                      subject: headers.subject?.[0] || 'No subject',\n                      from: headers.from?.[0] || 'Unknown',\n                      date: headers.date?.[0] || null,\n                      seqno\n                    });\n                  }\n                });\n              });\n              msg.once('attributes', attrs => {\n                const struct = attrs.struct;\n                let hasAtt = false;\n                function check(parts) {\n                  parts?.forEach(part => {\n                    if (Array.isArray(part)) check(part);\n                    else if (part.disposition?.type === 'ATTACHMENT') hasAtt = true;\n                  });\n                }\n                check(struct);\n                emails[emails.length - 1].hasAttachments = hasAtt;\n              });\n            });\n            fetch.once('end', () => {\n              console.log('\\n=== LAST 10 EMAILS ===');\n              emails.reverse().forEach((e, i) => {\n                console.log(`${i+1}. ${e.subject}`);\n                console.log(`   From: ${e.from}, Att: ${e.hasAttachments}, Date: ${e.date}`);\n                console.log('---');\n              });\n              imap.end();\n              resolve();\n            });\n            return;\n          }\n          // Fetch search results\n          const fetch = imap.seq.fetch(results, { bodies: 'HEADER.FIELDS (SUBJECT FROM DATE)', struct: true });\n          const hits = [];\n          fetch.on('message', (msg, seqno) => {\n            // similar parsing as above\n            msg.on('body', (stream, info) => {\n              let buffer = '';\n              stream.on('data', chunk => buffer += chunk);\n              stream.once('end', () => {\n                if (info.which.includes('HEADER')) {\n                  const headers = Imap.parseHeader(buffer);\n                  hits.push({\n                    subject: headers.subject?.[0],\n                    from: headers.from?.[0],\n                    date: headers.date?.[0]\n                  });\n                }\n              });\n            });\n          });\n          fetch.once('end', () => {\n            console.log('\\n=== SCHEDULE MATCHES ===');\n            hits.forEach(h => {\n              console.log(`Subject: ${h.subject}`);\n              console.log(`From: ${h.from}`);\n              console.log(`Date: ${h.date}`);\n            });\n            imap.end();\n            resolve();\n          });\n        });\n      });\n    });\n    imap.once('error', reject);\n    imap.connect();\n  });\n}\n\nmain().catch(e => console.error(e.message));